<html>
    <head>
        <title>{{ title }}: {{ room }}</title>
		<link rel="stylesheet" href="{{ url_for('static', filename='3rd_party/font-awesome-4.7.0/css/font-awesome.min.css') }}" />
		<link rel="stylesheet" href="{{ url_for('static', filename='css/global.css') }}" />
		<link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css') }}" />
        <script type="text/javascript" src="{{ url_for('static', filename='js/3rd_party/jquery-3.2.1.min.js') }}"></script>
        <script type="text/javascript" src="{{ url_for('static', filename='js/3rd_party/socket.io-2.0.3.min.js') }}"></script>
        <script type="text/javascript" charset="utf-8">
            window.onbeforeunload = function() {
                return "Are you sure you want to leave? Your may not completed the task after reloading or closing the page";
            };

            var socket;
            var typing = {};
            var self_user = undefined;
            var self_room = undefined;
            var invalid_ping_times = 0;
            var pings_received = 0;
            var history_received = false;
            var users = {};

            function getTime(timestamp) {
                if (typeof timestamp === "undefined")
                    return new Date().getHours() + ':' +  new Date().getMinutes();
                var currentDate = new Date((timestamp + new Date().getTimezoneOffset()*60)*1000);
                return currentDate.getHours() + ":" + (currentDate.getMinutes() < 10 ? "0"+currentDate.getMinutes() : ""+currentDate.getMinutes());
            }

            function append(text) {
	            $('#chat-area').append(text);
	            var content = $('#content');
                content.animate({scrollTop: content.prop("scrollHeight")}, 0);
            }

            function set_image(url) {
                $('#current-image').attr('src', url).show();
            }

            function print_history(history) {
                var latest_image = null;
                history.forEach(function(element) {
                    switch (element["type"]) {
                        case "text":
                            message(element["user"], getTime(element["timestamp"]), element["msg"], element["receiver_id"] !== null, false);
                            break;
                        case "command":
                            message(self_user, getTime(element["timestamp"]), element["command"], true, false);
                            break;
                        case "status":
                            console.log("status:", element);
                            break;
                        case "new_image":
                            latest_image = element["url"]
                    }
                });
                if (latest_image !== null)
                    set_image(latest_image);
            }

        function message(sender, time, message, privateMessage, skipSelf) {
              if (typeof self_user === "undefined")
                  return;
              var classes = "";
              if (self_user.id === sender.id) {
                  if (skipSelf) return;
                  classes += "self";
              } else {
                  classes += "other";
              }
              if (privateMessage)
                  classes += " private";
              var text = "<li class='"+classes+"'>" +
                         "  <div class='message-box'>" +
                         "    <div class='user'>"+(self_user.id === sender.id ? "You" : sender.name)+
                         "      <time>"+time+"</time>" +
                         "    </div>" +
                         "    <span class='msg'>"+message+"</span>" +
                         "  </div>" +
                         "</li>";
              append(text);
        }

        function image(sender, time, url, width, height, privateMessage, skipSelf) {
              if (typeof self_user === "undefined")
                  return;
              var classes = "", w = " width=200", h = " height=200";
              if (self_user.id === sender.id) {
                  if (skipSelf) return;
                  classes += "self";
              } else {
                  classes += "other";
              }
              if (privateMessage)
                  classes += " private";
              if (width !== null)
                  w = " width="+width;
              if (height !== null)
                  h = " height="+height;
              var text = "<li class='"+classes+"'>" +
                         "  <div class='message-box'>" +
                         "    <div class='user'>" +
                         "      <time>"+time+"</time>" +
                         "    </div>" +
                         "    <img src="+url+w+h+"/>" +
                         "  </div>" +
                         "</li>";
              append(text);
        }

        function display_own_message(time, message, privateMessage) {
              var classes = "self";

              if (privateMessage)
                  classes += " private";

              var text = "<li class='"+classes+"'>" +
                         "  <div class='message-box'>" +
                         "    <div class='user'>You"+
                         "      <time>"+time+"</time>" +
                         "    </div>" +
                         "    <span class='msg'>"+message+"</span>" +
                         "  </div>" +
                         "</li>";
              append(text);
        }

            function info(message, time) {
                var text = '<li class="notification">' +
                           '  <p>'+message+'</p>' +
                           '  <time>'+time+'</time>' +
                           '</li>';
                append(text);
            }

            function updateUsers() {
                var current_users = "You";
                for (var idx in users) {
                    current_users += ", " + users[idx];
                }
                $('#users').empty().append('<span>'+current_users+'</span>');
            }

            function updatePermissions(permissions) {
                console.log("new permissions:", permissions);
                if (permissions.write) {
                    $('#text').prop('readonly', false).prop('placeholder', 'Enter your message here!');
                } else {
                    $('#text').prop('readonly', true).prop('placeholder', 'You don\'t have the permissions to write in this room.');
                }
                if (permissions.see_latency)
                    $('#latency').show();
                else
                    $('#latency').hide();
                if (permissions.see_users)
                    $('#user-list').show();
                else
                    $('#user-list').hide();
                if (permissions.see_input)
                    $('#type-area').show();
                else
                    $('#type-area').hide();
                if (permissions.see_history)
                    $('#chat-area').show();
                else
                    $('#chat-area').hide();
                if (permissions.see_interaction_area)
                    $('#sidebar').show();
                else
                    $('#sidebar').hide();
            }

            $(document).ready(function(){
                {#$("#current-image").hide();#}
                $('#latency').hide();
                $('#user-list').hide();
                socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port + '/chat');
                var startTime;
                var ping_pong_times = [];
                window.setInterval(function () {
                    startTime = (new Date).getTime();
                    socket.emit("my_ping");
                    var date = new Date();
                    for (var sid in typing) {
                        if (typing[sid]['date'].getSeconds() + 3 < date.getSeconds())
                            delete typing[sid];
                    }
                    // updateTyping();
                }, 1000);

                socket.on('joined_room', function (data) {
                    console.log("permissions: ", data.permissions);
                    self_user = data.self;
                    self_user.name = "You";
                    self_room = data.room.id;

                    console.log("joined room:", data);
                    $("#chat-area").empty();
                    users = {};
                    data.users.forEach(function (user) {
                        users[user.id] = user.name;
                    });
                    updateUsers();
                    updatePermissions(data.permissions);
                    if (!history_received) {
                        print_history(data["history"]);
                        history_received = true;
                    }
                    var room = data.room;
                    $("#room").text(room.label)
                });

                socket.on("my_pong", function () {
                    pings_received += 1;

                    var latency = (new Date).getTime() - startTime;
                    ping_pong_times.push(latency);
                    ping_pong_times = ping_pong_times.slice(- {{ ping_pong_latency_checks }} );
                    var sum = 0;
                    for (var i = 0; i < ping_pong_times.length; ++i)
                        sum += ping_pong_times[i];
                    var ping = $("#ping");
                    ping.text(Math.round(10 * sum / ping_pong_times.length)/10);

                    if (parseFloat(ping.text()) >= {{ refresh_threshold }} && pings_received >= {{ refresh_start }}) {
                        invalid_ping_times += 1;
                        if (invalid_ping_times >= {{ refresh_max }}) {
                            // location.reload();
                        }
                    }
                });

                socket.on('status', function(data) {
                    console.log("status:", data);
                    if (typeof self_user === "undefined")
                        return;
	                switch (data.type) {
                        case "join":
                            var user = data.user;
                            if (user.id !== self_user) {
                                users[user.id] = user.name;
                                updateUsers();
                            }
                            break;
                        case "leave":
                            delete users[data.user.id];
                            updateUsers();
                            break;
                        case "new_image":
	                        info('You have received a new image!', getTime(data.timestamp));
	                        break;
                        case "undefined_command":
	                        info('Command could not be recognized!', getTime(data.timestamp));
	                        break;
                    }
                });

                socket.on('clear_chat_area', function() {
                    $('#chat-area').empty()
                });

                socket.on('message', function(data) {
                    console.log("Message:", data);
                    if (data["image"] !== undefined) {
                        console.log("image");
                        image(data.user, getTime(data.timestamp), data.image, data.width, data.height, data.privateMessage, true);
                    } else {
                        console.log("message");
                        message(data.user, getTime(data.timestamp), data.msg, data.privateMessage, true);
                    }
                });

                socket.on('update_permissions', function (data) {
                    updatePermissions(data.permissions)
                });

                socket.on('update_info_text', function (data) {
                    $("#status-text").text(data.text)
                });

	            socket.on('new_image', function(data) {
                    console.log("New image:", data);
                    set_image(data['url']);
	            });

	            $('#text').keypress(function(e) {
	                // socket.emit('keypress');
	                var code = e.keyCode || e.which;
	                if (code === 13) { // Return key
	                    var text = $(e.target).val();
	                    $(e.target).val('');
	                    if (text === '')
	                        return;

                        var currentDate = new Date();
                        var time = currentDate.getHours() + ":" + (currentDate.getMinutes() < 10 ? "0"+currentDate.getMinutes() : ""+currentDate.getMinutes());

	                    if (text.match("^/")) {
				            append("<li class='command'>" +
                                   "  <div class='message-box'>" +
							       "    <div class='user'>You"+
				                   "      <time>"+time+"</time>" +
				                   "    </div>" +
						           "    <span class='msg'>"+text.substr(1)+"</span>" +
						           "  </div>" +
                                   "</li>");
                            console.log({data: text.substr(1).split(' ')});
	                        socket.emit('command', {room: self_room, data: text.substr(1).split(' ')});
	                    } else {
                            display_own_message(time, text, false);
	                        socket.emit('text', {room: self_room, msg: text});
                        }
	                }
	            });
            });
        </script>
        <style>
            {{ css|safe }}
        </style>
    </head>
    <body>
		<header>
			<nav>
		    <h1 class="name">{{ heading }}</h1>
		    <h2 class="room" id="room">{{ room }}</h2>
            <span id="latency" class="latency">Latency: <span id="ping">999</span> ms</span>
            <span id="user-list" class="users">Users: <span id="users"></span></span>
			</nav>
		</header>
        <div id="sidebar">
            {{ html|safe }}
        </div>
		<div id="content">
	        <div id="chat-area"></div>
		</div>
		<div id="type-area">
            <input id="text" size="80" placeholder="Enter your message here!" readonly="readonly"><br><br>
		</div>
    </body>
</html>
