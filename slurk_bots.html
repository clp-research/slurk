<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>6. Writing your own bots &mdash; slurk 2.0.0 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="7. Bot-related events" href="slurk_bots_events.html" />
    <link rel="prev" title="5. Layouts and Plugins" href="slurk_layouts.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> slurk
          </a>
              <div class="version">
                2.0.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="slurk_about.html">1. Slurk: What’s this?</a></li>
<li class="toctree-l1"><a class="reference internal" href="slurk_prerequisites.html">2. Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="slurk_gettingstarted.html">3. Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="slurk_multibots.html">4. Pairing up participants and running multiple rooms</a></li>
<li class="toctree-l1"><a class="reference internal" href="slurk_layouts.html">5. Layouts and Plugins</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">6. Writing your own bots</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#dissecting-the-concierge-bot">6.1. Dissecting the concierge bot</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="slurk_bots_events.html">7. Bot-related events</a></li>
<li class="toctree-l1"><a class="reference internal" href="slurk_api.html">8. REST API for slurk</a></li>
<li class="toctree-l1"><a class="reference internal" href="slurk_deployment.html">9. Deployment of the system</a></li>
<li class="toctree-l1"><a class="reference internal" href="slurk_amt.html">10. Getting participants from Amazon Mechanical Turk</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">slurk</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li><span class="section-number">6. </span>Writing your own bots</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/slurk_bots.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="writing-your-own-bots">
<span id="slurk-bots"></span><h1><span class="section-number">6. </span>Writing your own bots<a class="headerlink" href="#writing-your-own-bots" title="Permalink to this headline"></a></h1>
<p>Bots are little client programs, which can both communicate with human clients and the server. By sending commands and responding to socket events they can perform various actions, e.g. sending messages, changing images shown to human clients, connecting clients to task rooms and handling dialogue tasks. Defining an experimental or data collection setting typically includes writing one or multiple bots.</p>
<p>There are some sample bots provided as examples, one of which is explained below.
The complete code to all bots can be found on <a class="reference external" href="https://github.com/clp-research/slurk-bots" target="_blank">GitHub</a>.</p>
<div class="section" id="dissecting-the-concierge-bot">
<h2><span class="section-number">6.1. </span>Dissecting the concierge bot<a class="headerlink" href="#dissecting-the-concierge-bot" title="Permalink to this headline"></a></h2>
<p>The concierge bot is an example for a bot able to group up users and move them into a newly created room.</p>
<p>The bot has to be started with a valid token, user id and optionally with a server URL and Port.
The URL defaults to <code class="docutils literal notranslate"><span class="pre">http://localhost</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># create bot instance</span>
<span class="n">concierge_bot</span> <span class="o">=</span> <span class="n">ConciergeBot</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">token</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">port</span><span class="p">)</span>
<span class="c1"># connect to chat server</span>
<span class="n">concierge_bot</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>If the connection was successful, the bot now listens to the events emitted by the server.
Listening on events is straightforward with adding new functions to the <code class="docutils literal notranslate"><span class="pre">register_callbacks</span></code> method.</p>
<p>The bot has to be notified when a user joins or leaves the room. For this purpose it can listen to the <code class="docutils literal notranslate"><span class="pre">status</span></code> event. More detailed information on existing events can be found in the next section.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ConciergeBot</span><span class="p">:</span>
    <span class="n">sio</span> <span class="o">=</span> <span class="n">socketio</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="n">logger</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This bot lists users joining a designated</span>
<span class="sd">        waiting room and sends a group of users to a task room</span>
<span class="sd">        as soon as the minimal number of users needed for the</span>
<span class="sd">        task is reached.</span>
<span class="sd">        :param token: A uuid; a string following the same pattern</span>
<span class="sd">            as `0c45b30f-d049-43d1-b80d-e3c3a3ca22a0`</span>
<span class="sd">        :type token: str</span>
<span class="sd">        :param user: id of a `User` object that was created with</span>
<span class="sd">        the token.</span>
<span class="sd">        :type user: int</span>
<span class="sd">        :param host: Full URL including protocol and hostname.</span>
<span class="sd">        :type host: str</span>
<span class="sd">        :param port: Port used by the slurk chat server.</span>
<span class="sd">        :type port: int</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uri</span> <span class="o">=</span> <span class="n">host</span>
        <span class="k">if</span> <span class="n">port</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uri</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uri</span> <span class="o">+=</span> <span class="s2">&quot;/slurk/api&quot;</span>

        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running concierge bot on </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">uri</span><span class="si">}</span><span class="s2"> with token </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># register all event handlers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">register_callbacks</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># establish a connection to the server</span>
        <span class="c1"># for authorization, the token has to be provided in the headers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sio</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uri</span><span class="p">,</span>
            <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">},</span>
            <span class="n">namespaces</span><span class="o">=</span><span class="s2">&quot;/&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># wait until the connection with the server ends</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sio</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">register_callbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nd">@self</span><span class="o">.</span><span class="n">sio</span><span class="o">.</span><span class="n">event</span>
        <span class="k">def</span> <span class="nf">status</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
            <span class="c1"># we differentiate between &quot;join&quot; and &quot;leave&quot; events</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;join&quot;</span><span class="p">:</span>
                <span class="c1"># get the user who has joined the room</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span>
                <span class="c1"># read the task associated with the user</span>
                <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_task</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
                <span class="c1"># join the task, if it exists</span>
                <span class="k">if</span> <span class="n">task</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">user_task_join</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;room&quot;</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;leave&quot;</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;user&quot;</span><span class="p">]</span>
                <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_user_task</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">task</span><span class="p">:</span>
                    <span class="c1"># leave the task as the user is not present anymore</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">user_task_leave</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">task</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">user_task_join</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">room</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A connected user and their task are registered.&quot;&quot;&quot;</span>
        <span class="n">task_id</span> <span class="o">=</span> <span class="n">task</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
        <span class="n">user_name</span> <span class="o">=</span> <span class="n">user</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="c1"># create/update entry for this task with the connected user</span>
        <span class="c1"># store the room, where the user waits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="p">{})[</span><span class="n">user_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">room</span>

        <span class="c1"># if we reach the required user number for a task</span>
        <span class="c1"># move those users into a new task room</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="n">task_id</span><span class="p">])</span> <span class="o">==</span> <span class="n">task</span><span class="p">[</span><span class="s2">&quot;num_users&quot;</span><span class="p">]:</span>
            <span class="c1"># create a new task room</span>
            <span class="n">new_room</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_room</span><span class="p">(</span><span class="n">task</span><span class="p">[</span><span class="s2">&quot;layout_id&quot;</span><span class="p">])</span>
            <span class="c1"># let every user join the new room and leave the old one</span>
            <span class="k">for</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">old_room_id</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="n">etag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">join_room</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">new_room</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">delete_room</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span> <span class="n">old_room_id</span><span class="p">,</span> <span class="n">etag</span><span class="p">)</span>
            <span class="c1"># clear the task entry as the users are now moved</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">tasks</span><span class="p">[</span><span class="n">task_id</span><span class="p">]</span>
            <span class="c1"># notify the server, that a room was created, so bots can join this room as well</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sio</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;room_created&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;room&quot;</span><span class="p">:</span> <span class="n">new_room</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="s2">&quot;task&quot;</span><span class="p">:</span> <span class="n">task_id</span><span class="p">})</span>
        <span class="c1"># if we do not have enough users for a task, send the new user a message</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sio</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span>
                <span class="s2">&quot;text&quot;</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;message&quot;</span><span class="p">:</span>
                        <span class="sa">f</span><span class="s2">&quot;### Hello, </span><span class="si">{</span><span class="n">user_name</span><span class="si">}</span><span class="s2">!</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;I am looking for a partner for you, it might take &quot;</span>
                        <span class="s2">&quot;some time, so be patient, please...&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;receiver_id&quot;</span><span class="p">:</span> <span class="n">user_id</span><span class="p">,</span>
                    <span class="s2">&quot;room&quot;</span><span class="p">:</span> <span class="n">room</span><span class="p">,</span>
                    <span class="s2">&quot;html&quot;</span><span class="p">:</span> <span class="kc">True</span>
                <span class="p">},</span>
                <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">message_callback</span>
            <span class="p">)</span>
</pre></div>
</div>
<p>In order to verify emits, a callback is provided to every call. Every callback is invoked with a success flag as the
first argument and an optional error message as a second argument, passed only if the success flag is <code class="docutils literal notranslate"><span class="pre">False</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@staticmethod</span>
<span class="k">def</span> <span class="nf">message_callback</span><span class="p">(</span><span class="n">success</span><span class="p">,</span> <span class="n">error_msg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not send message: </span><span class="si">{</span><span class="n">error_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Sent message successfully.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>In order to verify requests, one can read out their status code. For an overview of all status codes that a request could possibly return and their meaning view <a class="reference internal" href="slurk_api.html#slurk-api"><span class="std std-ref">REST API for slurk</span></a></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_user_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieve task assigned to user.&quot;&quot;&quot;</span>
    <span class="c1"># for authorization the token has to be provided in the headers</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">uri</span><span class="si">}</span><span class="s1">/users/</span><span class="si">{</span><span class="n">user</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">/task&#39;</span><span class="p">,</span>
        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Authorization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Bearer </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">token</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">task</span><span class="o">.</span><span class="n">ok</span><span class="p">:</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not get task: </span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">task</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Got user task successfully.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">task</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="slurk_layouts.html" class="btn btn-neutral float-left" title="5. Layouts and Plugins" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="slurk_bots_events.html" class="btn btn-neutral float-right" title="7. Bot-related events" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017-2018 DSG Bielefeld, 2019 CL Potsdam.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>