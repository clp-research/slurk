

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>9. Deployment of the system &mdash; slurk 2.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="10. Getting participants from Amazon Mechanical Turk" href="slurk_amt.html" />
    <link rel="prev" title="8. REST API for slurk" href="slurk_api.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> slurk
          

          
          </a>

          
            
            
              <div class="version">
                2.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="slurk_about.html">1. Slurk: What’s this?</a></li>
<li class="toctree-l1"><a class="reference internal" href="slurk_prerequisites.html">2. Prerequisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="slurk_gettingstarted.html">3. Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="slurk_multibots.html">4. Pairing up participants and running multiple rooms</a></li>
<li class="toctree-l1"><a class="reference internal" href="slurk_layouts.html">5. Layouts and Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="slurk_permission.html">6. Security and Permissions</a></li>
<li class="toctree-l1"><a class="reference internal" href="slurk_bots.html">7. Writing your own bots</a></li>
<li class="toctree-l1"><a class="reference internal" href="slurk_api.html">8. REST API for slurk</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">9. Deployment of the system</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#using-docker">9.1. Using docker</a></li>
<li class="toctree-l2"><a class="reference internal" href="#manual-setup">9.2. Manual setup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#general-description-and-requirements">9.2.1. General description and requirements</a></li>
<li class="toctree-l3"><a class="reference internal" href="#serving-slurk-with-gunicorn">9.2.2. Serving Slurk with Gunicorn</a></li>
<li class="toctree-l3"><a class="reference internal" href="#configuring-nginx">9.2.3. Configuring Nginx</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="slurk_amt.html">10. Getting participants from Amazon Mechanical Turk</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">slurk</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li><span class="section-number">9. </span>Deployment of the system</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/slurk_deployment.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="deployment-of-the-system">
<span id="slurk-deployment"></span><h1><span class="section-number">9. </span>Deployment of the system<a class="headerlink" href="#deployment-of-the-system" title="Permalink to this headline">¶</a></h1>
<div class="section" id="using-docker">
<h2><span class="section-number">9.1. </span>Using docker<a class="headerlink" href="#using-docker" title="Permalink to this headline">¶</a></h2>
<p>As described in <a class="reference internal" href="slurk_gettingstarted.html#slurk-gettingstarted"><span class="std std-ref">Getting Started</span></a>, the easiest way is to use <code class="docutils literal notranslate"><span class="pre">docker</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo apt-get install docker
</pre></div>
</div>
<p>In order to run the server on port 80, just run</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ docker run -p <span class="m">80</span>:5000 -e <span class="nv">SECRET_KEY</span><span class="o">=</span>your-key -d slurk/server
</pre></div>
</div>
<p>These additional environment variables can be specified:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">DEBUG</span></code>: admin token is <code class="docutils literal notranslate"><span class="pre">00000000-0000-0000-0000-000000000000</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">SQLALCHEMY_DATABASE_URI</span></code>: URI to the database, defaults to <code class="docutils literal notranslate"><span class="pre">sqlite:///:memory:</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">SQLALCHEMY_TRACK_MODIFICATIONS</span></code>: Tracks modifications in the database</li>
<li><code class="docutils literal notranslate"><span class="pre">SQLALCHEMY_ECHO</span></code>: Prints all executed commands to the database</li>
<li><code class="docutils literal notranslate"><span class="pre">DROP_DATABASE_ON_STARTUP</span></code>: Database will be recreated on restart</li>
</ul>
<p>If you don’t want to run it detached, you may omit <code class="docutils literal notranslate"><span class="pre">-d</span></code>.</p>
</div>
<div class="section" id="manual-setup">
<h2><span class="section-number">9.2. </span>Manual setup<a class="headerlink" href="#manual-setup" title="Permalink to this headline">¶</a></h2>
<p>If you don’t want to use docker for whatever reason, you can also manually setup the server.</p>
<div class="section" id="general-description-and-requirements">
<h3><span class="section-number">9.2.1. </span>General description and requirements<a class="headerlink" href="#general-description-and-requirements" title="Permalink to this headline">¶</a></h3>
<p>This section includes information on how to run Slurk on Nginx server (Ubuntu 18.04)
with SSL connection.</p>
<p>First, you have to be sure that Python3.6+ is installed on your machine. Please navigate to
<code class="docutils literal notranslate"><span class="pre">server</span></code> and install required packages via executing</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pip install -r requirements.txt
</pre></div>
</div>
<p>Also please make sure that your Ubuntu server is running on Nginx <a class="footnote-reference" href="#id6" id="id1">[1]</a> and <code class="docutils literal notranslate"><span class="pre">systemd</span></code> package is installed.
Do not forget to check if UFW (Uncomplicated Firewall) is installed on your machine <a class="footnote-reference" href="#id7" id="id2">[2]</a>.</p>
</div>
<div class="section" id="serving-slurk-with-gunicorn">
<h3><span class="section-number">9.2.2. </span>Serving Slurk with Gunicorn<a class="headerlink" href="#serving-slurk-with-gunicorn" title="Permalink to this headline">¶</a></h3>
<p>You can serve our Flask application on a permanent basis.
Such setup will allow you to have faster connections which are automatic since you are not required to manually start
the process with Python, but Nginx will configure everything for you. Most of the instructions are taken or adopted from
<a class="reference external" href="https://www.digitalocean.com/community/tutorials/how-to-serve-flask-applications-with-gunicorn-and-nginx-on-ubuntu-18-04" target="_blank">this tutorial</a>.</p>
<p>First, isolate your Flask application on your computer. For this you have to install <em>virtualenv</em> package.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo apt install python3-venv
</pre></div>
</div>
<p>Navigate to your project directory and create a new project environment there. Also activate the environment and
install required packages</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> ~/server
python3.6 -m venv serverenv
<span class="nb">source</span> serverenv/bin/activate
pip install -r requirements.txt
</pre></div>
</div>
<p>Now, assuming that <em>gunicorn</em> and <em>flask</em> are already installed, we will create the WSGI entry point for our application.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>nano ~/server/wsgi.py
</pre></div>
</div>
<p>The chat instance itself is created in <code class="docutils literal notranslate"><span class="pre">~/server/app/__init__.py</span></code>, and that is why we will use this instance in our <cite>wsgi.py</cite> file.
Import this instance into the file, save and close it once you are finished</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">create_app</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">create_app</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>Next step would be to configure Gunicorn, but first we should check if the application is served correctly <a class="footnote-reference" href="#id8" id="id3">[3]</a></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> ~/server
gunicorn --bind host:5000 -k geventwebsocket.gunicorn.workers.GeventWebSocketWorker wsgi:app
</pre></div>
</div>
<p>Visit you server’s address with the port <code class="docutils literal notranslate"><span class="pre">:5000</span></code> and check if you see the login page.
If it functions properly, please press <code class="docutils literal notranslate"><span class="pre">CTRL-C</span></code> in your terminal window and deactivate your environment.</p>
<p>Now we have to create the systemd service unit file. It will allow Ubuntu to automatically start our application
once the machine boots.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo nano /etc/systemd/system/chat.service
</pre></div>
</div>
<p>Fill this service file with information about your application and adjust paths/variable names where required</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span></span><span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">Gunicorn instance to serve MeetUp</span>
<span class="na">After</span><span class="o">=</span><span class="s">network.target</span>

<span class="k">[Service]</span>
<span class="na">User</span><span class="o">=</span><span class="s">user</span>
<span class="na">Group</span><span class="o">=</span><span class="s">www-data</span>
<span class="na">WorkingDirectory</span><span class="o">=</span><span class="s">/home/user/server</span>
<span class="na">Environment</span><span class="o">=</span><span class="s">&quot;PATH=/home/user/server/serverenv/bin&quot;</span>
<span class="na">ExecStart</span><span class="o">=</span><span class="s">/home/user/server/serverenv/bin/gunicorn --bind unix:myproject.sock -k geventwebsocket.gunicorn.workers.GeventWebSocketWorker -m 007 wsgi:app</span>

<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</pre></div>
</div>
<p>Save and close this file. Now we will start the Gunicorn service and enable it so that it is active once our machine is booted</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo systemctl start chat
sudo systemctl <span class="nb">enable</span> chat
</pre></div>
</div>
<p>To be sure that it is active, check its status</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo systemctl status chat
</pre></div>
</div>
<p>The output should be similar to the following</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>chat.service - Gunicorn instance to serve meetup
Loaded: loaded <span class="o">(</span>/etc/systemd/system/chat.service<span class="p">;</span> enabled<span class="p">;</span> vendor preset: enabled<span class="o">)</span>
Active: active <span class="o">(</span>running<span class="o">)</span> since Fri <span class="m">2018</span>-08-17 <span class="m">11</span>:25:12 CEST<span class="p">;</span> 4h 20min ago
Main PID: <span class="m">18101</span> <span class="o">(</span>gunicorn<span class="o">)</span>
Tasks: <span class="m">2</span> <span class="o">(</span>limit: <span class="m">4915</span><span class="o">)</span>
CGroup: /system.slice/chat.service
      ├─18101 /home/user/slurk/server/chatenv/bin/python3 /home/user/slurk/server/chatenv/bin/gunicorn --bind unix:chat.sock -k geventwebsocket.gunicorn.workers.GeventWebSocketWorker
      └─18103 /home/user/slurk/server/chatenv/bin/python3 /home/user/slurk/server/chatenv/bin/gunicorn --bind unix:chat.sock -k geventwebsocket.gunicorn.workers.GeventWebSocketWorker
</pre></div>
</div>
</div>
<div class="section" id="configuring-nginx">
<h3><span class="section-number">9.2.3. </span>Configuring Nginx<a class="headerlink" href="#configuring-nginx" title="Permalink to this headline">¶</a></h3>
<p>At this point our Gunicorn application server must be actively running, and now we have to enable Nginx to accept requests for our application.
First, we will create a new server block configuration file in Nginx’s <cite>sites-available</cite> directory</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo nano /etc/nginx/sites-available/chat
</pre></div>
</div>
<p>We will have to specify location of our socket file, that serves the application
and include certificates which were created earlier <a class="footnote-reference" href="#id9" id="id4">[4]</a></p>
<div class="highlight-nginx notranslate"><div class="highlight"><pre><span></span><span class="k">server</span> <span class="p">{</span>

    <span class="kn">listen</span> <span class="mi">5000</span> <span class="s">ssl</span> <span class="s">default_server</span><span class="p">;</span>
    <span class="kn">listen</span> <span class="s">[::]:5000</span> <span class="s">ssl</span> <span class="s">default_server</span><span class="p">;</span>

    <span class="kn">server_name</span> <span class="s">_</span><span class="p">;</span>
    <span class="kn">root</span> <span class="s">/home/user/slurk/server/app</span><span class="p">;</span>

    <span class="kn">access_log</span> <span class="s">/home/user/slurk/server/nginx_logs/nginx-access.log</span><span class="p">;</span>
    <span class="kn">error_log</span> <span class="s">/home/user/slurk/server/nginx_logs/nginx-error.log</span><span class="p">;</span>

    <span class="kn">include</span> <span class="s">snippets/certs.conf</span><span class="p">;</span>
    <span class="kn">include</span> <span class="s">snippets/ssl-params.conf</span><span class="p">;</span>

    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
        <span class="kn">include</span> <span class="s">proxy_params</span><span class="p">;</span>
        <span class="kn">proxy_pass</span> <span class="s">http://unix:/home/user/slurk/server/chat.sock</span><span class="p">;</span>

        <span class="p">}</span>

    <span class="p">}</span>
</pre></div>
</div>
<p>Do not forget to link this file to the <code class="docutils literal notranslate"><span class="pre">sites-enabled</span></code> directory</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo ln -s /etc/nginx/sites-available/myproject /etc/nginx/sites-enabled
</pre></div>
</div>
<p>Test it for syntax errors and restart Nginx</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo nginx -t
sudo systemctl restart nginx
</pre></div>
</div>
<p>As the last step, adjust UFW setting once again, adding full access to the Nginx server</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo ufw delete allow <span class="m">5000</span>
sudo ufw allow <span class="s1">&#39;Nginx Full&#39;</span>
</pre></div>
</div>
<p>When you navigate to your server’s domain name, you should be able to see the login interface <a class="footnote-reference" href="#id10" id="id5">[5]</a>.</p>
<p>Congratulations! You have managed to fully deploy Slurk!</p>
<hr class="docutils" />
<table class="docutils footnote" frame="void" id="id6" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>There is a nice tutorial on <a class="reference external" href="https://www.digitalocean.com/community/tutorials/how-to-install-nginx-on-ubuntu-18-04" target="_blank">how to install Nginx on Ubuntu 18.04</a>.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id7" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>A very detailed tutorial can be found here: <a class="reference external" href="https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-18-04" target="_blank">Initial Server Setup with Ubuntu 18.04</a>.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id8" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[3]</a></td><td><p class="first">An important thing is that you specify type of the worker associated with the Gunicorn process. You should use websockets provided by <cite>gevent</cite> package:</p>
<p><code class="docutils literal notranslate"><span class="pre">-k</span> <span class="pre">geventwebsocket.gunicorn.workers.GeventWebSocketWorker</span></code></p>
<p class="last">More information can be found in <a class="reference external" href="http://flask.pocoo.org/docs/1.0/deploying/wsgi-standalone/#gunicorn" target="_blank">official Flask documentation</a>.</p>
</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id9" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[4]</a></td><td><p class="first">Different configurations require specification of static files’ location,
which include CSS files of your applications. In order to enable it, add additional
location block where you specify location of the static files:</p>
<div class="last highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">location</span> <span class="o">/</span><span class="n">static</span><span class="o">/</span> <span class="p">{</span>
    <span class="n">alias</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">user</span><span class="o">/</span><span class="n">server</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">main</span><span class="o">/</span><span class="n">static</span><span class="o">/</span><span class="p">;</span>
    <span class="p">}</span>
</pre></div>
</div>
</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id10" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[5]</a></td><td>Regarding the port that you use: some ports are not accessible for the use (for example, <code class="docutils literal notranslate"><span class="pre">7000</span></code> is used for internal processes), so be careful when deciding which port to use.
If you choose incorrect one, the application will not be accessible from outside of your network, even if you adjust firewall settings.</td></tr>
</tbody>
</table>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="slurk_amt.html" class="btn btn-neutral float-right" title="10. Getting participants from Amazon Mechanical Turk" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="slurk_api.html" class="btn btn-neutral float-left" title="8. REST API for slurk" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2017-2018 DSG Bielefeld, 2019 CL Potsdam.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>